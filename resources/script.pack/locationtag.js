/// Copyright (c) 2004-2011, Needlworks  / Tatter Network Foundation
/// All rights reserved. Licensed under the GPL.
/// See the GNU General Public License for more details. (/documents/LICENSE, /documents/COPYRIGHT)
// 입력창을 10ms마다 체크하면서 값이 변했으면 request를 보낸다.
// 파이어폭스에서는 한글을 입력할때 keydown 이벤트가 발생하지 않기 때문에
// 값이 변하는지 계속 보고있어야 한다.
function debug(a){try{document.getElementById("debug").innerHTML=++x+")"+a+"<br />"+document.getElementById("debug").innerHTML}catch(b){}}function getOffsetLeft(a){return a?a.offsetLeft+getOffsetLeft(a.offsetParent):0}function getOffsetTop(a){return a?a.offsetTop+getOffsetTop(a.offsetParent):0}function LocationTag(a,b,c){this.name="Eolin Location Tag Object",this.copyright="Tatter & Company",this.allowEolinSuggestion=typeof c=="undefined"?!1:!c,this.isFocused=!1,this.isSettingValue=!1,this.instance=this,this.cursor=0,this.inputClassName="",this.language="ko",typeof b!="undefined"&&(this.language=b),this.isTyping=!1,this.isSuggestionShown=!1,this.typingText="",this.container=a,this.container.instance=this,this.suggestion=document.createElement("ul"),this.suggestion.instance=this,this.suggestion.selectedIndex=0,this.suggestion.className="eolinSuggest",this.suggestion.style.margin="0px",this.suggestion.style.padding="0px",this.suggestion.style.listStyleType="none",this.suggestion.style.position="absolute",this.suggestion.style.display="none",this.suggestion.style.zIndex="999",this.input=document.createElement("input"),this.input.instance=this,this.input.className=this.inputClassName,this.input.setAttribute("autocomplete","off"),this.input.onblur=function(){this.instance.isTyping=!1,this.instance.typingText="",this.instance.setValue(this.value),this.instance.isFocused=!1},this.input.onfocus=function(){this.instance.isFocused||(this.instance.isFocused=!0,this.instance.isTyping=!0,this.instance.typingText=this.value,this.instance.requestSuggestion())},this.input.onkeydown=function(a){var b=this.instance;b.isTyping=!0,a=b.adjustEventCompatibility(a);switch(a.keyCode){case 8:if(this.value=="")b.moveBack();else return a.keyCode;break;case 13:b.setValue(this.value,!0);break;case 191:if(!a.shiftKey)b.setValue(this.value,!0);else return a.keyCode;break;case 9:if(this.value.trim()=="")return a.keyCode;b.setValue(this.value,!0);break;case 27:b.hideSuggestion();break;case 38:b.moveUp();break;case 40:b.moveDown();break;default:return a.keyCode}a.returnValue=!1,a.cancelBubble=!0;try{a.preventDefault()}catch(c){}return!1},this.input.onkeypress=function(a){return preventEnter(a)},this.input.onkeyup=function(a){var b=this.instance;b.isTyping=!0,a=b.adjustEventCompatibility(a);switch(a.keyCode){case 191:b.setValue(this.value,!0);break;default:return a.keyCode}a.returnValue=!1,a.cancelBubble=!0;try{a.preventDefault()}catch(c){}return!1},setInterval("eolinLocationTagFunction_WatchInputBox('"+this.container.id+"')",10),this.locationList=document.createElement("ul"),this.locationList.instance=this;var d=document.createElement("li");d.className="lastChild",d.appendChild(this.input),this.locationList.appendChild(d),this.container.appendChild(this.locationList)}function eolinLocationTagFunction_showSuggestion(){try{var a=document.getElementById(arguments[0]).instance}catch(b){return}debug('<span style="color: red">Received '+a.cursor+"</span>");if(a.cursor==arguments[1]&&!!a.isTyping){a.suggestion.style.left=getOffsetLeft(a.input)+"px",a.suggestion.style.top=getOffsetTop(a.input)+a.input.offsetHeight+"px";var c=new StringBuffer;if(arguments[2]==0)for(var d=3;d<arguments.length;d++)arguments[d]=arguments[d].replaceAll("&quot;",'"'),STD.isSafari&&(arguments[d]=decodeURIComponent(arguments[d])),c.append('<li onmouseover="this.className=\'hover\'" onmouseout="this.className=\'\'" onmousedown="this.parentNode.instance.suggestionMouseClick(this)">'),c.append(arguments[d].replace(new RegExp("("+a.input.value+")","gi"),"<em>$1</em>")),c.append("</li>");else{var e=arguments[3],f=arguments[4],g=arguments[5];STD.isSafari&&(e=decodeURIComponent(e),f=decodeURIComponent(f),g=decodeURIComponent(g)),a.locationList.childNodes.length==1?c.append('<li class="disabled"><em>'+a.input.value+"</em> - "+e+"<br />"+f+"</li>"):a.input.value.trim()==""?c.append('<li class="disabled">'+g+"</li>"):c.append('<li class="disabled"><em>'+a.input.value+"</em> - "+e+"</li>")}a.suggestion.innerHTML=c.toString(),a.suggestion.style.display="block",a.isSuggestionShown=!0;try{document.body.removeChild(a.suggestion)}catch(b){}document.body.appendChild(a.suggestion)}}function eolinLocationFunction_showLocalSuggestion(a,b,c){try{var d=document.getElementById(a).instance}catch(e){return}if(d.cursor==b&&!!d.isTyping){var f=d.input,g=createHttp();g&&(g.open("GET",blogURL+"/locationSuggest/?id="+a+"&cursor="+b+"&filter="+(STD.isSafari?c:encodeURIComponent(c)),!0),g.onreadystatechange=function(){if(g.readyState==4)try{var a=g.responseXML,b=a.getElementsByTagName("response")[0],d=b.getAttribute("id"),e=b.getAttribute("cursor"),h=document.getElementById(d).instance;if(h.cursor==e){var i=[],j=b.getElementsByTagName("location");if(!h.allowEolinSuggestion&&j.length==0){h.hideSuggestion();return}for(var k=0;k<j.length;k++){value=j[k].lastChild.nodeValue.split("/");for(var l=0;l!=-1;l=c.indexOf("/",l+1)){if(l==0)continue;value.shift()}i[i.length]=value.join("/")}for(var k=0;k<i.length;k++)for(var l=0;l<h.suggestion.childNodes.length;l++)if(i[k]==h.suggestion.childNodes[l].innerHTML.replace(new RegExp("</?em>","gi"),"")){h.suggestion.removeChild(h.suggestion.childNodes[l]);break}var m=new StringBuffer;for(var k=0;k<i.length;k++)m.append('<li onmouseover="this.className=\'hover\'" onmouseout="this.className=\'\'" onmousedown="this.parentNode.instance.suggestionMouseClick(this)" style="background-color: #ccb"><em>'),m.append(i[k].substring(0,f.value.length).htmlspecialchars().replaceAll("&amp;","&")),m.append("</em>"),m.append(i[k].substring(f.value.length).htmlspecialchars().replaceAll("&amp;","&")),m.append("</li>");h.allowEolinSuggestion&&m.append(h.suggestion.innerHTML),h.suggestion.innerHTML=m.toString();if(!h.allowEolinSuggestion||h.input.value.trim()==""){h.suggestion.style.left=getOffsetLeft(f)+"px",h.suggestion.style.top=getOffsetTop(f)+f.offsetHeight+"px",h.suggestion.style.display="block",h.isSuggestionShown=!0;try{document.body.removeChild(h.suggestion)}catch(n){}document.body.appendChild(h.suggestion)}while(h.suggestion.childNodes.length>10)h.suggestion.removeChild(h.suggestion.childNodes[h.suggestion.childNodes.length-1])}}catch(n){}},g.send(null),delete g)}}function eolinLocationTagFunction_WatchInputBox(a){try{var b=document.getElementById(a).instance;if(b.input.value.charAt(b.input.value.length-1)=="/"){input.value.length==1?input.value="":b.setValue(b.input.value,!0);return}b.input.value!=b.typingText&&(b.typingText=b.input.value,b.requestSuggestion())}catch(c){}}LocationTag.prototype.getValues=function(){var a=[];for(var b=0;b<this.locationList.childNodes.length-1;b++)a[b]=this.locationList.childNodes[b].innerHTML.trim().unhtmlspecialchars();return"/"+a.join("/")},LocationTag.prototype.setValue=function(a,b){if(!this.isSettingValue){this.isSettingValue=!0,this.hideSuggestion();var c=this.stringToLocation(a),d=this.input;this.input.parentNode.parentNode.removeChild(this.input.parentNode);for(var e=0;e<c.length;e++){var f=document.createElement("li");f.onclick=this.locationListMouseClick,f.appendChild(document.createTextNode(c[e])),this.locationList.appendChild(f)}var f=document.createElement("li");f.appendChild(this.input),this.locationList.appendChild(f),this.locationList.lastChild.className="lastChild",this.input.value="",this.typingText="",b&&(this.focusOnInput(),navigator.userAgent.indexOf("Gecko")!=-1&&this.requestSuggestion()),this.isSettingValue=!1}},LocationTag.prototype.focusOnInput=function(){this.input.focus(),this.input.select();try{setTimeout("document.getElementById('"+this.container.id+"').instance.input.focus()",1)}catch(a){}},LocationTag.prototype.setInputClassName=function(a){this.inputClassName=a,this.input.className=a},LocationTag.prototype.suggestionMouseClick=function(a){this.setValue(a.innerHTML.replace(new RegExp("</?em>","gi"),"").replaceAll("&amp;","&"),!0),this.hideSuggestion()},LocationTag.prototype.locationListMouseClick=function(a){var b=this.parentNode.instance,c=b.input;c.value=this.innerHTML.unhtmlspecialchars();while(this.nextSibling)this.parentNode.removeChild(this.nextSibling);this.typingText="",this.innerHTML="",this.onclick=null,this.appendChild(c),b.focusOnInput()},LocationTag.prototype.hideSuggestion=function(){this.isSuggestionShown=!1,this.suggestion.style.display="none",this.suggestion.selectedIndex=0},LocationTag.prototype.moveUp=function(){this.isSuggestionShown&&(this.cursor++,this.suggestion.selectedIndex--,this.suggestion.selectedIndex<1&&(this.suggestion.selectedIndex=this.suggestion.childNodes.length),this.highlightRow())},LocationTag.prototype.moveBack=function(){var a=this.input.parentNode.previousSibling;if(this.locationList.childNodes.length>1&&a){this.hideSuggestion();var b=a.innerHTML.unhtmlspecialchars();a.parentNode.removeChild(a),this.locationList.lastChild.className="lastChild",this.input.value=b}},LocationTag.prototype.moveDown=function(){this.isSuggestionShown&&(this.cursor++,this.suggestion.selectedIndex++,this.suggestion.selectedIndex>this.suggestion.childNodes.length&&(this.suggestion.selectedIndex=1),this.highlightRow())},LocationTag.prototype.highlightRow=function(){if(this.isSuggestionShown&&this.suggestion.childNodes[0].className!="disabled"){for(var a=0;a<this.suggestion.childNodes.length;a++)this.suggestion.childNodes[a].className=a==this.suggestion.selectedIndex-1?"hover":"";this.input.value=this.typingText=this.suggestion.childNodes[this.suggestion.selectedIndex-1].innerHTML.replace(new RegExp("</?em>","gi"),"").unhtmlspecialchars()}},LocationTag.prototype.getPath=function(){var a=this.getValues();return a+(a=="/"?"":"/")+this.input.value},LocationTag.prototype.requestSuggestion=function(){var a=this.instance;if(!a.allowEolinSuggestion||a.input.value.trim()=="")eolinLocationFunction_showLocalSuggestion(a.container.getAttribute("id"),a.cursor,this.getPath());else{a.isTyping=!0,a.cursor++,debug("Request "+a.cursor);var b=document.createElement("script");b.setAttribute("src","http://suggest.eolin.com/location/script/?id="+a.container.getAttribute("id")+"&cursor="+a.cursor+"&language="+a.language+"&path="+encodeURIComponent(a.getPath())+(STD.isSafari?"&encode=1":"")),document.body.appendChild(b)}},LocationTag.prototype.stringToLocation=function(a){try{var b=[],c=a.split("/");for(var d=0;d<c.length;d++)c[d].trim()!=""&&(b[b.length]=c[d].trim());return b}catch(e){return[]}},LocationTag.prototype.adjustEventCompatibility=function(a){navigator.appName=="Microsoft Internet Explorer"&&(a=window.event,a.target=a.srcElement);return a};var StringBuffer=function(){this.buffer=[]};StringBuffer.prototype.append=function(a){this.buffer[this.buffer.length]=a},StringBuffer.prototype.toString=function(){return this.buffer.join("")},String.prototype.trim||(String.prototype.trim=function(){return this.replace(new RegExp("(^\\s*)|(\\s*$)","g"),"")}),String.prototype.htmlspecialchars||(String.prototype.htmlspecialchars=function(){return this.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll("<","&gt;")}),String.prototype.unhtmlspecialchars||(String.prototype.unhtmlspecialchars=function(){return this.replaceAll("&amp;","&").replaceAll("&lt;","<").replaceAll("&gt;",">")});var x=0