/*
	Copyright (c) 2004-2006, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/community/licensing.shtml
*/dojo.provide("dojo.dnd.HtmlDragAndDrop"),dojo.require("dojo.dnd.HtmlDragManager"),dojo.require("dojo.dnd.DragAndDrop"),dojo.require("dojo.html.*"),dojo.require("dojo.html.display"),dojo.require("dojo.html.util"),dojo.require("dojo.html.selection"),dojo.require("dojo.html.iframe"),dojo.require("dojo.lang.extras"),dojo.require("dojo.lfx.*"),dojo.require("dojo.event.*"),dojo.declare("dojo.dnd.HtmlDragSource",dojo.dnd.DragSource,{dragClass:"",onDragStart:function(){var a=new dojo.dnd.HtmlDragObject(this.dragObject,this.type);this.dragClass&&(a.dragClass=this.dragClass),this.constrainToContainer&&a.constrainTo(this.constrainingContainer||this.domNode.parentNode);return a},setDragHandle:function(a){a=dojo.byId(a),dojo.dnd.dragManager.unregisterDragSource(this),this.domNode=a,dojo.dnd.dragManager.registerDragSource(this)},setDragTarget:function(a){this.dragObject=a},constrainTo:function(a){this.constrainToContainer=!0,a&&(this.constrainingContainer=a)},onSelected:function(){for(var a=0;a<this.dragObjects.length;a++)dojo.dnd.dragManager.selectedSources.push(new dojo.dnd.HtmlDragSource(this.dragObjects[a]))},addDragObjects:function(a){for(var b=0;b<arguments.length;b++)this.dragObjects.push(dojo.byId(arguments[b]))}},function(a,b){a=dojo.byId(a),this.dragObjects=[],this.constrainToContainer=!1,a&&(this.domNode=a,this.dragObject=a,this.type=b||this.domNode.nodeName.toLowerCase(),dojo.dnd.DragSource.prototype.reregister.call(this))}),dojo.declare("dojo.dnd.HtmlDragObject",dojo.dnd.DragObject,{dragClass:"",opacity:.5,createIframe:!0,disableX:!1,disableY:!1,createDragNode:function(){var node=this.domNode.cloneNode(!0);this.dragClass&&dojo.html.addClass(node,this.dragClass),this.opacity<1&&dojo.html.setOpacity(node,this.opacity);var ltn=node.tagName.toLowerCase(),isTr=ltn=="tr";if(isTr||ltn=="tbody"){var doc=this.domNode.ownerDocument,table=doc.createElement("table");if(isTr){var tbody=doc.createElement("tbody");table.appendChild(tbody),tbody.appendChild(node)}else table.appendChild(node);var tmpSrcTr=isTr?this.domNode:this.domNode.firstChild,tmpDstTr=isTr?node:node.firstChild,domTds=tmpSrcTr.childNodes,cloneTds=tmpDstTr.childNodes;for(var i=0;i<domTds.length;i++)cloneTds[i]&&cloneTds[i].style&&(cloneTds[i].style.width=dojo.html.getContentBox(domTds[i]).width+"px");node=table}if((dojo.render.html.ie55||dojo.render.html.ie60)&&this.createIframe){with(node.style)top="0px",left="0px";var outer=document.createElement("div");outer.appendChild(node),this.bgIframe=new dojo.html.BackgroundIframe(outer),outer.appendChild(this.bgIframe.iframe),node=outer}node.style.zIndex=999;return node},onDragStart:function(e){dojo.html.clearSelection(),this.scrollOffset=dojo.html.getScroll().offset,this.dragStartPosition=dojo.html.getAbsolutePosition(this.domNode,!0),this.dragOffset={y:this.dragStartPosition.y-e.pageY,x:this.dragStartPosition.x-e.pageX},this.dragClone=this.createDragNode(),this.containingBlockPosition=this.domNode.offsetParent?dojo.html.getAbsolutePosition(this.domNode.offsetParent,!0):{x:0,y:0},this.constrainToContainer&&(this.constraints=this.getConstraints());with(this.dragClone.style)position="absolute",top=this.dragOffset.y+e.pageY+"px",left=this.dragOffset.x+e.pageX+"px";dojo.body().appendChild(this.dragClone),dojo.event.topic.publish("dragStart",{source:this})},getConstraints:function(){if(this.constrainingContainer.nodeName.toLowerCase()=="body")var a=dojo.html.getViewport(),b=a.width,c=a.height,d=dojo.html.getScroll().offset,e=d.x,f=d.y;else{var g=dojo.html.getContentBox(this.constrainingContainer);b=g.width,c=g.height,e=this.containingBlockPosition.x+dojo.html.getPixelValue(this.constrainingContainer,"padding-left",!0)+dojo.html.getBorderExtent(this.constrainingContainer,"left"),f=this.containingBlockPosition.y+dojo.html.getPixelValue(this.constrainingContainer,"padding-top",!0)+dojo.html.getBorderExtent(this.constrainingContainer,"top")}var h=dojo.html.getMarginBox(this.domNode);return{minX:e,minY:f,maxX:e+b-h.width,maxY:f+c-h.height}},updateDragOffset:function(){var a=dojo.html.getScroll().offset;if(a.y!=this.scrollOffset.y){var b=a.y-this.scrollOffset.y;this.dragOffset.y+=b,this.scrollOffset.y=a.y}if(a.x!=this.scrollOffset.x){var b=a.x-this.scrollOffset.x;this.dragOffset.x+=b,this.scrollOffset.x=a.x}},onDragMove:function(a){this.updateDragOffset();var b=this.dragOffset.x+a.pageX,c=this.dragOffset.y+a.pageY;this.constrainToContainer&&(b<this.constraints.minX&&(b=this.constraints.minX),c<this.constraints.minY&&(c=this.constraints.minY),b>this.constraints.maxX&&(b=this.constraints.maxX),c>this.constraints.maxY&&(c=this.constraints.maxY)),this.setAbsolutePosition(b,c),dojo.event.topic.publish("dragMove",{source:this})},setAbsolutePosition:function(a,b){this.disableY||(this.dragClone.style.top=b+"px"),this.disableX||(this.dragClone.style.left=a+"px")},onDragEnd:function(a){switch(a.dragStatus){case"dropSuccess":dojo.html.removeNode(this.dragClone),this.dragClone=null;break;case"dropFailure":var b=dojo.html.getAbsolutePosition(this.dragClone,!0),c={left:this.dragStartPosition.x+1,top:this.dragStartPosition.y+1},d=dojo.lfx.slideTo(this.dragClone,c,300),e=this;dojo.event.connect(d,"onEnd",function(a){dojo.html.removeNode(e.dragClone),e.dragClone=null}),d.play()}dojo.event.topic.publish("dragEnd",{source:this})},constrainTo:function(a){this.constrainToContainer=!0,a?this.constrainingContainer=a:this.constrainingContainer=this.domNode.parentNode}},function(a,b){this.domNode=dojo.byId(a),this.type=b,this.constrainToContainer=!1,this.dragSource=null,dojo.dnd.DragObject.prototype.register.call(this)}),dojo.declare("dojo.dnd.HtmlDropTarget",dojo.dnd.DropTarget,{vertical:!1,onDragOver:function(a){if(!this.accepts(a.dragObjects))return!1;this.childBoxes=[];for(var b=0,c;b<this.domNode.childNodes.length;b++){c=this.domNode.childNodes[b];if(c.nodeType!=dojo.html.ELEMENT_NODE)continue;var d=dojo.html.getAbsolutePosition(c,!0),e=dojo.html.getBorderBox(c);this.childBoxes.push({top:d.y,bottom:d.y+e.height,left:d.x,right:d.x+e.width,height:e.height,width:e.width,node:c})}return!0},_getNodeUnderMouse:function(e){for(var i=0,child;i<this.childBoxes.length;i++)with(this.childBoxes[i])if(e.pageX>=left&&e.pageX<=right&&e.pageY>=top&&e.pageY<=bottom)return i;return-1},createDropIndicator:function(){this.dropIndicator=document.createElement("div");with(this.dropIndicator.style)position="absolute",zIndex=999,this.vertical?(borderLeftWidth="1px",borderLeftColor="black",borderLeftStyle="solid",height=dojo.html.getBorderBox(this.domNode).height+"px",top=dojo.html.getAbsolutePosition(this.domNode,!0).y+"px"):(borderTopWidth="1px",borderTopColor="black",borderTopStyle="solid",width=dojo.html.getBorderBox(this.domNode).width+"px",left=dojo.html.getAbsolutePosition(this.domNode,!0).x+"px")},onDragMove:function(a,b){var c=this._getNodeUnderMouse(a);this.dropIndicator||this.createDropIndicator();var d=this.vertical?dojo.html.gravity.WEST:dojo.html.gravity.NORTH,e=!1;if(c<0)if(this.childBoxes.length){var f=dojo.html.gravity(this.childBoxes[0].node,a)&d;f&&(e=!0)}else var f=!0;else{var g=this.childBoxes[c],f=dojo.html.gravity(g.node,a)&d;if(g.node===b[0].dragSource.domNode)e=!0;else{var h=f?c>0?this.childBoxes[c-1]:g:c<this.childBoxes.length-1?this.childBoxes[c+1]:g;h.node===b[0].dragSource.domNode&&(e=!0)}}e?this.dropIndicator.style.display="none":(this.dropIndicator.style.display="",this.placeIndicator(a,b,c,f),dojo.html.hasParent(this.dropIndicator)||dojo.body().appendChild(this.dropIndicator))},placeIndicator:function(a,b,c,d){var e=this.vertical?"left":"top",f;c<0?this.childBoxes.length?f=d?this.childBoxes[0]:this.childBoxes[this.childBoxes.length-1]:this.dropIndicator.style[e]=dojo.html.getAbsolutePosition(this.domNode,!0)[this.vertical?"x":"y"]+"px":f=this.childBoxes[c],f&&(this.dropIndicator.style[e]=(d?f[e]:f[this.vertical?"right":"bottom"])+"px",this.vertical?(this.dropIndicator.style.height=f.height+"px",this.dropIndicator.style.top=f.top+"px"):(this.dropIndicator.style.width=f.width+"px",this.dropIndicator.style.left=f.left+"px"))},onDragOut:function(a){this.dropIndicator&&(dojo.html.removeNode(this.dropIndicator),delete this.dropIndicator)},onDrop:function(a){this.onDragOut(a);var b=this._getNodeUnderMouse(a),c=this.vertical?dojo.html.gravity.WEST:dojo.html.gravity.NORTH;if(b<0){if(this.childBoxes.length)return dojo.html.gravity(this.childBoxes[0].node,a)&c?this.insert(a,this.childBoxes[0].node,"before"):this.insert(a,this.childBoxes[this.childBoxes.length-1].node,"after");return this.insert(a,this.domNode,"append")}var d=this.childBoxes[b];return dojo.html.gravity(d.node,a)&c?this.insert(a,d.node,"before"):this.insert(a,d.node,"after")},insert:function(a,b,c){var d=a.dragObject.domNode;if(c=="before")return dojo.html.insertBefore(d,b);if(c=="after")return dojo.html.insertAfter(d,b);if(c=="append"){b.appendChild(d);return!0}return!1}},function(a,b){arguments.length!=0&&(this.domNode=dojo.byId(a),dojo.dnd.DropTarget.call(this),b&&dojo.lang.isString(b)&&(b=[b]),this.acceptedTypes=b||[],dojo.dnd.dragManager.registerDropTarget(this))})