/*
	Copyright (c) 2004-2006, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/community/licensing.shtml
*/dojo.provide("dojo.dnd.HtmlDragManager"),dojo.require("dojo.dnd.DragAndDrop"),dojo.require("dojo.event.*"),dojo.require("dojo.lang.array"),dojo.require("dojo.html.common"),dojo.require("dojo.html.layout"),dojo.declare("dojo.dnd.HtmlDragManager",dojo.dnd.DragManager,{disabled:!1,nestedTargets:!1,mouseDownTimer:null,dsCounter:0,dsPrefix:"dojoDragSource",dropTargetDimensions:[],currentDropTarget:null,previousDropTarget:null,_dragTriggered:!1,selectedSources:[],dragObjects:[],dragSources:[],dropTargets:[],currentX:null,currentY:null,lastX:null,lastY:null,mouseDownX:null,mouseDownY:null,threshold:7,dropAcceptable:!1,cancelEvent:function(a){a.stopPropagation(),a.preventDefault()},registerDragSource:function(a){if(a.domNode){var b=this.dsPrefix,c=b+"Idx_"+this.dsCounter++;a.dragSourceId=c,this.dragSources[c]=a,a.domNode.setAttribute(b,c),dojo.render.html.ie&&dojo.event.browser.addListener(a.domNode,"ondragstart",this.cancelEvent)}},unregisterDragSource:function(a){if(a.domNode){var b=this.dsPrefix,c=a.dragSourceId;delete a.dragSourceId,delete this.dragSources[c],a.domNode.setAttribute(b,null),dojo.render.html.ie&&dojo.event.browser.removeListener(a.domNode,"ondragstart",this.cancelEvent)}},registerDropTarget:function(a){this.dropTargets.push(a)},unregisterDropTarget:function(a){var b=dojo.lang.find(this.dropTargets,a,!0);b>=0&&this.dropTargets.splice(b,1)},getDragSource:function(a){var b=a.target;if(b!==dojo.body()){var c=dojo.html.getAttribute(b,this.dsPrefix);while(!c&&b){b=b.parentNode;if(!b||b===dojo.body())return;c=dojo.html.getAttribute(b,this.dsPrefix)}return this.dragSources[c]}},onKeyDown:function(a){},onMouseDown:function(a){if(!this.disabled){if(dojo.render.html.ie){if(a.button!=1)return}else if(a.which!=1)return;var b=a.target.nodeType==dojo.html.TEXT_NODE?a.target.parentNode:a.target;if(dojo.html.isTag(b,"button","textarea","input","select","option"))return;var c=this.getDragSource(a);if(!c)return;dojo.lang.inArray(this.selectedSources,c)||(this.selectedSources.push(c),c.onSelected()),this.mouseDownX=a.pageX,this.mouseDownY=a.pageY,a.preventDefault(),dojo.event.connect(document,"onmousemove",this,"onMouseMove")}},onMouseUp:function(a,b){this.selectedSources.length!=0&&(this.mouseDownX=null,this.mouseDownY=null,this._dragTriggered=!1,a.dragSource=this.dragSource,!a.shiftKey&&!a.ctrlKey&&(this.currentDropTarget&&this.currentDropTarget.onDropStart(),dojo.lang.forEach(this.dragObjects,function(b){var c=null;if(!!b){if(this.currentDropTarget){a.dragObject=b;var d=this.currentDropTarget.domNode.childNodes;if(d.length>0){a.dropTarget=d[0];while(a.dropTarget==b.domNode)a.dropTarget=a.dropTarget.nextSibling}else a.dropTarget=this.currentDropTarget.domNode;this.dropAcceptable?c=this.currentDropTarget.onDrop(a):this.currentDropTarget.onDragOut(a)}a.dragStatus=this.dropAcceptable&&c?"dropSuccess":"dropFailure",dojo.lang.delayThese([function(){try{b.dragSource.onDragEnd(a)}catch(c){var d={};for(var f in a){if(f=="type"){d.type="mouseup";continue}d[f]=a[f]}b.dragSource.onDragEnd(d)}},function(){b.onDragEnd(a)}])}},this),this.selectedSources=[],this.dragObjects=[],this.dragSource=null,this.currentDropTarget&&this.currentDropTarget.onDropEnd()),dojo.event.disconnect(document,"onmousemove",this,"onMouseMove"),this.currentDropTarget=null)},onScroll:function(){for(var a=0;a<this.dragObjects.length;a++)this.dragObjects[a].updateDragOffset&&this.dragObjects[a].updateDragOffset();this.dragObjects.length&&this.cacheTargetLocations()},_dragStartDistance:function(a,b){if(!!this.mouseDownX&&!!this.mouseDownX){var c=Math.abs(a-this.mouseDownX),d=c*c,e=Math.abs(b-this.mouseDownY),f=e*e;return parseInt(Math.sqrt(d+f),10)}},cacheTargetLocations:function(){dojo.profile.start("cacheTargetLocations"),this.dropTargetDimensions=[],dojo.lang.forEach(this.dropTargets,function(a){var b=a.domNode;if(!!b&&!!a.accepts([this.dragSource])){var c=dojo.html.getAbsolutePosition(b,!0),d=dojo.html.getBorderBox(b);this.dropTargetDimensions.push([[c.x,c.y],[c.x+d.width,c.y+d.height],a])}},this),dojo.profile.end("cacheTargetLocations")},onMouseMove:function(a){if(dojo.render.html.ie&&a.button!=1)this.currentDropTarget=null,this.onMouseUp(a,!0);else{if(this.selectedSources.length&&!this.dragObjects.length){var b,c;if(!this._dragTriggered){this._dragTriggered=this._dragStartDistance(a.pageX,a.pageY)>this.threshold;if(!this._dragTriggered)return;b=a.pageX-this.mouseDownX,c=a.pageY-this.mouseDownY}this.dragSource=this.selectedSources[0],dojo.lang.forEach(this.selectedSources,function(d){if(!!d){var e=d.onDragStart(a);e&&(e.onDragStart(a),e.dragOffset.y+=c,e.dragOffset.x+=b,e.dragSource=d,this.dragObjects.push(e))}},this),this.previousDropTarget=null,this.cacheTargetLocations()}dojo.lang.forEach(this.dragObjects,function(b){b&&b.onDragMove(a)});if(this.currentDropTarget)var d=dojo.html.toCoordinateObject(this.currentDropTarget.domNode,!0),e=[[d.x,d.y],[d.x+d.width,d.y+d.height]];if(!this.nestedTargets&&e&&this.isInsideBox(a,e))this.dropAcceptable&&this.currentDropTarget.onDragMove(a,this.dragObjects);else{var f=this.findBestTarget(a);if(f.target===null){this.currentDropTarget&&(this.currentDropTarget.onDragOut(a),this.previousDropTarget=this.currentDropTarget,this.currentDropTarget=null),this.dropAcceptable=!1;return}this.currentDropTarget!==f.target?(this.currentDropTarget&&(this.previousDropTarget=this.currentDropTarget,this.currentDropTarget.onDragOut(a)),this.currentDropTarget=f.target,a.dragObjects=this.dragObjects,this.dropAcceptable=this.currentDropTarget.onDragOver(a)):this.dropAcceptable&&this.currentDropTarget.onDragMove(a,this.dragObjects)}}},findBestTarget:function(a){var b=this,c=new Object;c.target=null,c.points=null,dojo.lang.every(this.dropTargetDimensions,function(d){if(!b.isInsideBox(a,d))return!0;c.target=d[2],c.points=d;return Boolean(b.nestedTargets)});return c},isInsideBox:function(a,b){if(a.pageX>b[0][0]&&a.pageX<b[1][0]&&a.pageY>b[0][1]&&a.pageY<b[1][1])return!0;return!1},onMouseOver:function(a){},onMouseOut:function(a){}}),dojo.dnd.dragManager=new dojo.dnd.HtmlDragManager,function(){var a=document,b=dojo.dnd.dragManager;dojo.event.connect(a,"onkeydown",b,"onKeyDown"),dojo.event.connect(a,"onmouseover",b,"onMouseOver"),dojo.event.connect(a,"onmouseout",b,"onMouseOut"),dojo.event.connect(a,"onmousedown",b,"onMouseDown"),dojo.event.connect(a,"onmouseup",b,"onMouseUp"),dojo.event.connect(window,"onscroll",b,"onScroll")}()