/*
	Copyright (c) 2004-2006, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/community/licensing.shtml
*/dojo.provide("dojo.widget.ContentPane"),dojo.require("dojo.widget.*"),dojo.require("dojo.io.*"),dojo.require("dojo.widget.HtmlWidget"),dojo.require("dojo.string"),dojo.require("dojo.string.extras"),dojo.require("dojo.html.style"),dojo.widget.defineWidget("dojo.widget.ContentPane",dojo.widget.HtmlWidget,function(){this._styleNodes=[],this._onLoadStack=[],this._onUnloadStack=[],this._callOnUnload=!1,this._ioBindObj,this.scriptScope,this.bindArgs={}},{isContainer:!0,adjustPaths:!0,href:"",extractContent:!0,parseContent:!0,cacheContent:!0,preload:!1,refreshOnShow:!1,handler:"",executeScripts:!1,scriptSeparation:!0,loadingMessage:"Loading...",isLoaded:!1,postCreate:function(a,b,c){this.handler!==""&&this.setHandler(this.handler),(this.isShowing()||this.preload)&&this.loadContents()},show:function(){this.refreshOnShow?this.refresh():this.loadContents(),dojo.widget.ContentPane.superclass.show.call(this)},refresh:function(){this.isLoaded=!1,this.loadContents()},loadContents:function(){this.isLoaded||(dojo.lang.isFunction(this.handler)?this._runHandler():this.href!=""&&this._downloadExternalContent(this.href,this.cacheContent&&!this.refreshOnShow))},setUrl:function(a){this.href=a,this.isLoaded=!1,(this.preload||this.isShowing())&&this.loadContents()},abort:function(){var a=this._ioBindObj;!!a&&!!a.abort&&(a.abort(),delete this._ioBindObj)},_downloadExternalContent:function(a,b){this.abort(),this._handleDefaults(this.loadingMessage,"onDownloadStart");var c=this;this._ioBindObj=dojo.io.bind(this._cacheSetting({url:a,mimetype:"text/html",handler:function(b,d,e){delete c._ioBindObj;if(b=="load")c.onDownloadEnd.call(c,a,d);else{var f={responseText:e.responseText,status:e.status,statusText:e.statusText,responseHeaders:e.getAllResponseHeaders(),text:"Error loading '"+a+"' ("+e.status+" "+e.statusText+")"};c._handleDefaults.call(c,f,"onDownloadError"),c.onLoad()}}},b))},_cacheSetting:function(a,b){for(var c in this.bindArgs)dojo.lang.isUndefined(a[c])&&(a[c]=this.bindArgs[c]);dojo.lang.isUndefined(a.useCache)&&(a.useCache=b),dojo.lang.isUndefined(a.preventCache)&&(a.preventCache=!b),dojo.lang.isUndefined(a.mimetype)&&(a.mimetype="text/html");return a},onLoad:function(a){this._runStack("_onLoadStack"),this.isLoaded=!0},onUnLoad:function(a){dojo.deprecated(this.widgetType+".onUnLoad, use .onUnload (lowercased load)",.5)},onUnload:function(a){this._runStack("_onUnloadStack"),delete this.scriptScope,this.onUnLoad!==dojo.widget.ContentPane.prototype.onUnLoad&&this.onUnLoad.apply(this,arguments)},_runStack:function(a){var b=this[a],c="",d=this.scriptScope||window;for(var e=0;e<b.length;e++)try{b[e].call(d)}catch(f){c+="\n"+b[e]+" failed: "+f.description}this[a]=[];if(c.length){var g=a=="_onLoadStack"?"addOnLoad":"addOnUnLoad";this._handleDefaults(g+" failure\n "+c,"onExecError","debug")}},addOnLoad:function(a,b){this._pushOnStack(this._onLoadStack,a,b)},addOnUnload:function(a,b){this._pushOnStack(this._onUnloadStack,a,b)},addOnUnLoad:function(){dojo.deprecated(this.widgetType+".addOnUnLoad, use addOnUnload instead. (lowercased Load)",.5),this.addOnUnload.apply(this,arguments)},_pushOnStack:function(a,b,c){typeof c=="undefined"?a.push(b):a.push(function(){b[c]()})},destroy:function(){this.onUnload(),dojo.widget.ContentPane.superclass.destroy.call(this)},onExecError:function(a){},onContentError:function(a){},onDownloadError:function(a){},onDownloadStart:function(a){},onDownloadEnd:function(a,b){b=this.splitAndFixPaths(b,a),this.setContent(b)},_handleDefaults:function(a,b,c){b||(b="onContentError"),dojo.lang.isString(a)&&(a={text:a}),a.text||(a.text=a.toString()),a.toString=function(){return this.text},typeof a.returnValue!="boolean"&&(a.returnValue=!0),typeof a.preventDefault!="function"&&(a.preventDefault=function(){this.returnValue=!1}),this[b](a);if(a.returnValue)switch(c){case!0:case"alert":alert(a.toString());break;case"debug":dojo.debug(a.toString());break;default:this._callOnUnload&&this.onUnload(),this._callOnUnload=!1,arguments.callee._loopStop?dojo.debug(a.toString()):(arguments.callee._loopStop=!0,this._setContent(a.toString()))}arguments.callee._loopStop=!1},splitAndFixPaths:function(a,b){var c=[],d=[],e=[],f=[],g=[],h=[],i=[],j="",k="",l="",m="",n="",o="";b||(b="./");if(a){var p=/<title[^>]*>([\s\S]*?)<\/title>/i;while(f=p.exec(a))c.push(f[1]),a=a.substring(0,f.index)+a.substr(f.index+f[0].length);if(this.adjustPaths){var q=/<[a-z][a-z0-9]*[^>]*\s(?:(?:src|href|style)=[^>])+[^>]*>/i,r=/\s(src|href|style)=(['"]?)([\w()\[\]\/.,\\'"-:;#=&?\s@]+?)\2/i,s=/^(?:[#]|(?:(?:https?|ftps?|file|javascript|mailto|news):))/;while(n=q.exec(a)){j+=a.substring(0,n.index),a=a.substring(n.index+n[0].length,a.length),n=n[0],m="";while(h=r.exec(n)){k="",o=h[3];switch(h[1].toLowerCase()){case"src":case"href":s.exec(o)?k=o:k=(new dojo.uri.Uri(b,o)).toString();break;case"style":k=dojo.html.fixPathsInCssText(o,b);break;default:k=o}l=" "+h[1]+"="+h[2]+k+h[2],m+=n.substring(0,h.index)+l,n=n.substring(h.index+h[0].length,n.length)}j+=m+n}a=j+a}p=/(?:<(style)[^>]*>([\s\S]*?)<\/style>|<link ([^>]*rel=['"]?stylesheet['"]?[^>]*)>)/i;while(f=p.exec(a))f[1]&&f[1].toLowerCase()=="style"?i.push(dojo.html.fixPathsInCssText(f[2],b)):(h=f[3].match(/href=(['"]?)([^'">]*)\1/i))&&i.push({path:h[2]}),a=a.substring(0,f.index)+a.substr(f.index+f[0].length);var p=/<script([^>]*)>([\s\S]*?)<\/script>/i,t=/src=(['"]?)([^"']*)\1/i,u=/.*(\bdojo\b\.js(?:\.uncompressed\.js)?)$/,v=/(?:var )?\bdjConfig\b(?:[\s]*=[\s]*\{[^}]+\}|\.[\w]*[\s]*=[\s]*[^;\n]*)?;?|dojo\.hostenv\.writeIncludes\(\s*\);?/g,w=/dojo\.(?:(?:require(?:After)?(?:If)?)|(?:widget\.(?:manager\.)?registerWidgetPackage)|(?:(?:hostenv\.)?setModulePrefix|registerModulePath)|defineNamespace)\((['"]).*?\1\)\s*;?/;while(f=p.exec(a)){this.executeScripts&&f[1]&&(h=t.exec(f[1]))&&(u.exec(h[2])?dojo.debug("Security note! inhibit:"+h[2]+" from  being loaded again."):d.push({path:h[2]}));if(f[2]){var x=f[2].replace(v,"");if(!x)continue;while(e=w.exec(x))g.push(e[0]),x=x.substring(0,e.index)+x.substr(e.index+e[0].length);this.executeScripts&&d.push(x)}a=a.substr(0,f.index)+a.substr(f.index+f[0].length)}this.extractContent&&(f=a.match(/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im),f&&(a=f[1]));if(this.executeScripts&&this.scriptSeparation){var p=/(<[a-zA-Z][a-zA-Z0-9]*\s[^>]*?\S=)((['"])[^>]*scriptScope[^>]*>)/,y=/([\s'";:\(])scriptScope(.*)/;j="";while(n=p.exec(a)){e=n[3]=="'"?'"':"'",l="",j+=a.substring(0,n.index)+n[1];while(h=y.exec(n[2]))n[2]=n[2].substring(0,h.index)+h[1]+"dojo.widget.byId("+e+this.widgetId+e+").scriptScope"+h[2];j+=n[2],a=a.substr(n.index+n[0].length)}a=j+a}}return{xml:a,styles:i,titles:c,requires:g,scripts:d,url:b}},_setContent:function(a){this.destroyChildren();for(var b=0;b<this._styleNodes.length;b++)this._styleNodes[b]&&this._styleNodes[b].parentNode&&this._styleNodes[b].parentNode.removeChild(this._styleNodes[b]);this._styleNodes=[];try{var c=this.containerNode||this.domNode;while(c.firstChild)dojo.html.destroyNode(c.firstChild);typeof a!="string"?c.appendChild(a):c.innerHTML=a}catch(d){d.text="Couldn't load content:"+d.description,this._handleDefaults(d,"onContentError")}},setContent:function(data){this.abort(),this._callOnUnload&&this.onUnload(),this._callOnUnload=!0;if(!data||dojo.html.isNode(data))this._setContent(data),this.onResized(),this.onLoad();else{typeof data.xml!="string"&&(this.href="",data=this.splitAndFixPaths(data)),this._setContent(data.xml);for(var i=0;i<data.styles.length;i++)data.styles[i].path?this._styleNodes.push(dojo.html.insertCssFile(data.styles[i].path,dojo.doc(),!1,!0)):this._styleNodes.push(dojo.html.insertCssText(data.styles[i]));if(this.parseContent)for(var i=0;i<data.requires.length;i++)try{eval(data.requires[i])}catch(e){e.text="ContentPane: error in package loading calls, "+(e.description||e),this._handleDefaults(e,"onContentError","debug")}var _self=this;function asyncParse(){_self.executeScripts&&_self._executeScripts(data.scripts);if(_self.parseContent){var a=_self.containerNode||_self.domNode,b=new dojo.xml.Parse,c=b.parseElement(a,null,!0);dojo.widget.getParser().createSubComponents(c,_self)}_self.onResized(),_self.onLoad()}dojo.hostenv.isXDomain&&data.requires.length?dojo.addOnLoad(asyncParse):asyncParse()}},setHandler:function(a){var b=dojo.lang.isFunction(a)?a:window[a];dojo.lang.isFunction(b)?this.handler=function(){return b.apply(this,arguments)}:this._handleDefaults("Unable to set handler, '"+a+"' not a function.","onExecError",!0)},_runHandler:function(){var a=!0;dojo.lang.isFunction(this.handler)&&(this.handler(this,this.domNode),a=!1),this.onLoad();return a},_executeScripts:function(a){var b=this,c="",d="";for(var e=0;e<a.length;e++)a[e].path?(dojo.io.bind(this._cacheSetting({url:a[e].path,load:function(a,d){dojo.lang.hitch(b,c=";"+d)},error:function(a,c){c.text=a+" downloading remote script",b._handleDefaults.call(b,c,"onExecError","debug")},mimetype:"text/plain",sync:!0},this.cacheContent)),d+=c):d+=a[e];try{if(this.scriptSeparation)delete this.scriptScope,this.scriptScope=new new Function("_container_",d+"; return this;")(b);else{var f=dojo.global();if(f.execScript)f.execScript(d);else{var g=dojo.doc(),h=g.createElement("script");h.appendChild(g.createTextNode(d)),(this.containerNode||this.domNode).appendChild(h)}}}catch(i){i.text="Error running scripts from content:\n"+i.description,this._handleDefaults(i,"onExecError","debug")}}})