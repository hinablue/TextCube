/*
	Copyright (c) 2004-2006, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/community/licensing.shtml
*/dojo.provide("dojo.widget.DomWidget"),dojo.require("dojo.event.*"),dojo.require("dojo.widget.Widget"),dojo.require("dojo.dom"),dojo.require("dojo.html.style"),dojo.require("dojo.xml.Parse"),dojo.require("dojo.uri.*"),dojo.require("dojo.lang.func"),dojo.require("dojo.lang.extras"),dojo.widget._cssFiles={},dojo.widget._cssStrings={},dojo.widget._templateCache={},dojo.widget.defaultStrings={dojoRoot:dojo.hostenv.getBaseScriptUri(),dojoWidgetModuleUri:dojo.uri.moduleUri("dojo.widget"),baseScriptUri:dojo.hostenv.getBaseScriptUri()},dojo.widget.fillFromTemplateCache=function(a,b,c,d){var e=b||a.templatePath,f=dojo.widget._templateCache;if(!e&&!a.widgetType){do var g="__dummyTemplate__"+dojo.widget._templateCache.dummyCount++;while(f[g]);a.widgetType=g}var h=e?e.toString():a.widgetType,i=f[h];i||(f[h]={string:null,node:null},d?i={}:i=f[h]),!a.templateString&&!d&&(a.templateString=c||i.string),a.templateString&&(a.templateString=this._sanitizeTemplateString(a.templateString)),!a.templateNode&&!d&&(a.templateNode=i.node);if(!a.templateNode&&!a.templateString&&e){var j=this._sanitizeTemplateString(dojo.hostenv.getText(e));a.templateString=j,d||(f[h].string=j)}!i.string&&!d&&(i.string=a.templateString)},dojo.widget._sanitizeTemplateString=function(a){if(a){a=a.replace(/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,"");var b=a.match(/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im);b&&(a=b[1])}else a="";return a},dojo.widget._templateCache.dummyCount=0,dojo.widget.attachProperties=["dojoAttachPoint","id"],dojo.widget.eventAttachProperty="dojoAttachEvent",dojo.widget.onBuildProperty="dojoOnBuild",dojo.widget.waiNames=["waiRole","waiState"],dojo.widget.wai={waiRole:{name:"waiRole",namespace:"http://www.w3.org/TR/xhtml2",alias:"x2",prefix:"wairole:"},waiState:{name:"waiState",namespace:"http://www.w3.org/2005/07/aaa",alias:"aaa",prefix:""},setAttr:function(a,b,c,d){dojo.render.html.ie?a.setAttribute(this[b].alias+":"+c,this[b].prefix+d):a.setAttributeNS(this[b].namespace,c,this[b].prefix+d)},getAttr:function(a,b,c){return dojo.render.html.ie?a.getAttribute(this[b].alias+":"+c):a.getAttributeNS(this[b].namespace,c)},removeAttr:function(a,b,c){var d=!0;dojo.render.html.ie?d=a.removeAttribute(this[b].alias+":"+c):a.removeAttributeNS(this[b].namespace,c);return d}},dojo.widget.attachTemplateNodes=function(rootNode,targetObj,events){function trim(a){return a.replace(/^\s+|\s+$/g,"")}var elementNodeType=dojo.dom.ELEMENT_NODE;rootNode||(rootNode=targetObj.domNode);if(rootNode.nodeType==elementNodeType){var nodes=rootNode.all||rootNode.getElementsByTagName("*"),_this=targetObj;for(var x=-1;x<nodes.length;x++){var baseNode=x==-1?rootNode:nodes[x],attachPoint=[];if(!targetObj.widgetsInTemplate||!baseNode.getAttribute("dojoType")){for(var y=0;y<this.attachProperties.length;y++){var tmpAttachPoint=baseNode.getAttribute(this.attachProperties[y]);if(tmpAttachPoint){attachPoint=tmpAttachPoint.split(";");for(var z=0;z<attachPoint.length;z++)dojo.lang.isArray(targetObj[attachPoint[z]])?targetObj[attachPoint[z]].push(baseNode):targetObj[attachPoint[z]]=baseNode;break}}var attachEvent=baseNode.getAttribute(this.eventAttachProperty);if(attachEvent){var evts=attachEvent.split(";");for(var y=0;y<evts.length;y++){if(!evts[y]||!evts[y].length)continue;var thisFunc=null,tevt=trim(evts[y]);if(evts[y].indexOf(":")>=0){var funcNameArr=tevt.split(":");tevt=trim(funcNameArr[0]),thisFunc=trim(funcNameArr[1])}thisFunc||(thisFunc=tevt);var tf=function(){var a=new String(thisFunc);return function(b){_this[a]&&_this[a](dojo.event.browser.fixEvent(b,this))}}();dojo.event.browser.addListener(baseNode,tevt,tf,!1,!0)}}for(var y=0;y<events.length;y++){var evtVal=baseNode.getAttribute(events[y]);if(evtVal&&evtVal.length){var thisFunc=null,domEvt=events[y].substr(4);thisFunc=trim(evtVal);var funcs=[thisFunc];thisFunc.indexOf(";")>=0&&(funcs=dojo.lang.map(thisFunc.split(";"),trim));for(var z=0;z<funcs.length;z++){if(!funcs[z].length)continue;var tf=function(){var a=new String(funcs[z]);return function(b){_this[a]&&_this[a](dojo.event.browser.fixEvent(b,this))}}();dojo.event.browser.addListener(baseNode,domEvt,tf,!1,!0)}}}}var tmpltPoint=baseNode.getAttribute(this.templateProperty);tmpltPoint&&(targetObj[tmpltPoint]=baseNode),dojo.lang.forEach(dojo.widget.waiNames,function(a){var b=dojo.widget.wai[a],c=baseNode.getAttribute(b.name);if(c)if(c.indexOf("-")==-1)dojo.widget.wai.setAttr(baseNode,b.name,"role",c);else{var d=c.split("-");dojo.widget.wai.setAttr(baseNode,b.name,d[0],d[1])}},this);var onBuild=baseNode.getAttribute(this.onBuildProperty);onBuild&&eval("var node = baseNode; var widget = targetObj; "+onBuild)}}},dojo.widget.getDojoEventsFromStr=function(a){var b=/(dojoOn([a-z]+)(\s?))=/gi,c=a?a.match(b)||[]:[],d=[],e={};for(var f=0;f<c.length;f++){if(c[f].length<1)continue;var g=c[f].replace(/\s/,"");g=g.slice(0,g.length-1),e[g]||(e[g]=!0,d.push(g))}return d},dojo.declare("dojo.widget.DomWidget",dojo.widget.Widget,function(){arguments.length>0&&typeof arguments[0]=="object"&&this.create(arguments[0])},{templateNode:null,templateString:null,templateCssString:null,preventClobber:!1,domNode:null,containerNode:null,widgetsInTemplate:!1,addChild:function(a,b,c,d,e){if(!this.isContainer){dojo.debug("dojo.widget.DomWidget.addChild() attempted on non-container widget");return null}e==undefined&&(e=this.children.length),this.addWidgetAsDirectChild(a,b,c,d,e),this.registerChild(a,e);return a},addWidgetAsDirectChild:function(a,b,c,d,e){!this.containerNode&&!b&&(this.containerNode=this.domNode);var f=b?b:this.containerNode;c||(c="after"),d||(f||(f=dojo.body()),d=f.lastChild),e||(e=0),a.domNode.setAttribute("dojoinsertionindex",e),d?c=="insertAtIndex"?dojo.dom.insertAtIndex(a.domNode,d.parentNode,e):c=="after"&&d===f.lastChild?f.appendChild(a.domNode):dojo.dom.insertAtPosition(a.domNode,f,c):f.appendChild(a.domNode)},registerChild:function(a,b){a.dojoInsertionIndex=b;var c=-1;for(var d=0;d<this.children.length;d++)this.children[d].dojoInsertionIndex<=b&&(c=d);this.children.splice(c+1,0,a),a.parent=this,a.addedTo(this,c+1),delete dojo.widget.manager.topWidgets[a.widgetId]},removeChild:function(a){dojo.dom.removeNode(a.domNode);return dojo.widget.DomWidget.superclass.removeChild.call(this,a)},getFragNodeRef:function(a){if(!a)return null;a[this.getNamespacedType()]||dojo.raise("Error: no frag for widget type "+this.getNamespacedType()+", id "+this.widgetId+" (maybe a widget has set it's type incorrectly)");return a[this.getNamespacedType()].nodeRef},postInitialize:function(a,b,c){var d=this.getFragNodeRef(b);c&&(c.snarfChildDomOutput||!d)?c.addWidgetAsDirectChild(this,"","insertAtIndex","",a.dojoinsertionindex,d):d&&this.domNode&&this.domNode!==d&&(this._sourceNodeRef=dojo.dom.replaceNode(d,this.domNode)),c?c.registerChild(this,a.dojoinsertionindex):dojo.widget.manager.topWidgets[this.widgetId]=this;if(this.widgetsInTemplate){var e=new dojo.xml.Parse,f,g=this.domNode.getElementsByTagName("*");for(var h=0;h<g.length;h++)g[h].getAttribute("dojoAttachPoint")=="subContainerWidget"&&(f=g[h]),g[h].getAttribute("dojoType")&&g[h].setAttribute("isSubWidget",!0);if(this.isContainer&&!this.containerNode)if(f){var i=this.getFragNodeRef(b);i&&(dojo.dom.moveChildren(i,f),b.dojoDontFollow=!0)}else dojo.debug("No subContainerWidget node can be found in template file for widget "+this);var j=e.parseElement(this.domNode,null,!0);dojo.widget.getParser().createSubComponents(j,this);var k=[],l=[this],m;while(m=l.pop())for(var h=0;h<m.children.length;h++){var n=m.children[h];if(n._processedSubWidgets||!n.extraArgs.issubwidget)continue;k.push(n),n.isContainer&&l.push(n)}for(var h=0;h<k.length;h++){var o=k[h];if(o._processedSubWidgets){dojo.debug("This should not happen: widget._processedSubWidgets is already true!");return}o._processedSubWidgets=!0;if(o.extraArgs.dojoattachevent){var p=o.extraArgs.dojoattachevent.split(";");for(var q=0;q<p.length;q++){var r=null,s=dojo.string.trim(p[q]);if(s.indexOf(":")>=0){var t=s.split(":");s=dojo.string.trim(t[0]),r=dojo.string.trim(t[1])}r||(r=s),dojo.lang.isFunction(o[s])?dojo.event.kwConnect({srcObj:o,srcFunc:s,targetObj:this,targetFunc:r}):alert(s+" is not a function in widget "+o)}}o.extraArgs.dojoattachpoint&&(this[o.extraArgs.dojoattachpoint]=o)}}this.isContainer&&!b.dojoDontFollow&&dojo.widget.getParser().createSubComponents(b,this)},buildRendering:function(a,b){var c=dojo.widget._templateCache[this.widgetType];a.templatecsspath&&(a.templateCssPath=a.templatecsspath);var d=a.templateCssPath||this.templateCssPath;d&&!dojo.widget._cssFiles[d.toString()]&&(!this.templateCssString&&d&&(this.templateCssString=dojo.hostenv.getText(d),this.templateCssPath=null),dojo.widget._cssFiles[d.toString()]=!0),this.templateCssString&&!dojo.widget._cssStrings[this.templateCssString]&&(dojo.html.insertCssText(this.templateCssString,null,d),dojo.widget._cssStrings[this.templateCssString]=!0),!this.preventClobber&&(this.templatePath||this.templateNode||this.templateString&&this.templateString.length||typeof c!="undefined"&&(c.string||c.node))?this.buildFromTemplate(a,b):this.domNode=this.getFragNodeRef(b),this.fillInTemplate(a,b)},buildFromTemplate:function(a,b){var c=!1;a.templatepath&&(a.templatePath=a.templatepath),dojo.widget.fillFromTemplateCache(this,a.templatePath,null,c);var d=dojo.widget._templateCache[this.templatePath?this.templatePath.toString():this.widgetType];d&&!c&&(this.templateString.length||(this.templateString=d.string),this.templateNode||(this.templateNode=d.node));var e=!1,f=null,g=this.templateString;if(!this.templateNode&&this.templateString){e=this.templateString.match(/\$\{([^\}]+)\}/g);if(e){var h=this.strings||{};for(var i in dojo.widget.defaultStrings)dojo.lang.isUndefined(h[i])&&(h[i]=dojo.widget.defaultStrings[i]);for(var j=0;j<e.length;j++){var i=e[j];i=i.substring(2,i.length-1);var k=i.substring(0,5)=="this."?dojo.lang.getObjPathValue(i.substring(5),this):h[i],l;if(k||dojo.lang.isString(k)){l=new String(dojo.lang.isFunction(k)?k.call(this,i,this.templateString):k);while(l.indexOf('"')>-1)l=l.replace('"',"&quot;");g=g.replace(e[j],l)}}}else this.templateNode=this.createNodesFromText(this.templateString,!0)[0],c||(d.node=this.templateNode)}if(!this.templateNode&&!e){dojo.debug("DomWidget.buildFromTemplate: could not create template");return!1}if(!e){f=this.templateNode.cloneNode(!0);if(!f)return!1}else f=this.createNodesFromText(g,!0)[0];this.domNode=f,this.attachTemplateNodes();if(this.isContainer&&this.containerNode){var m=this.getFragNodeRef(b);m&&dojo.dom.moveChildren(m,this.containerNode)}},attachTemplateNodes:function(a,b){a||(a=this.domNode),b||(b=this);return dojo.widget.attachTemplateNodes(a,b,dojo.widget.getDojoEventsFromStr(this.templateString))},fillInTemplate:function(){},destroyRendering:function(){try{dojo.dom.destroyNode(this.domNode),delete this.domNode}catch(a){}if(this._sourceNodeRef)try{dojo.dom.destroyNode(this._sourceNodeRef)}catch(a){}},createNodesFromText:function(){dojo.unimplemented("dojo.widget.DomWidget.createNodesFromText")}})